#include "thingProperties.h"
#include "DHT.h"
#define DHT_TYPE DHT11
int DHT_PIN = D1;
int relPin = D2;
int trigPin = D7;
int echoPin = D8;

DHT dht(DHT_PIN, DHT_TYPE);
unsigned long lastReadTime = 0;
unsigned long lastReadTime2 = 0;
void setup() {
  Serial.begin(9600);
  delay(1500); 
  dht.begin();
  initProperties();
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();
  pinMode(LED_BUILTIN, OUTPUT);
  pinMode(relPin, OUTPUT);
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
}

void loop() {
  ArduinoCloud.update();
  
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();
  if (millis() - lastReadTime >= 2000) {  
  if (!isnan(temperature) && !isnan(humidity)) {
    Serial.print("Temperature: ");
    Serial.print(temperature);
    Serial.print("Â°C, Humidity: ");
    Serial.print(humidity);
    Serial.println("%");
    
    suhu = temperature;
    kelembaban = humidity;
    
  } else {
    Serial.println("DHT11 reading error!");
  }
}

  // Read ultrasonic sensor
  if (millis() - lastReadTime2 >= 500) {
    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    
    long duration = pulseIn(echoPin, HIGH);
    float distance = duration * 0.034 / 2;
    ultra=distance;
    lastReadTime2 = millis();
    
  }

  if (led==true) {
    digitalWrite(LED_BUILTIN, LOW);
  } else {
    digitalWrite(LED_BUILTIN, HIGH);
  }
    
  if (suhu>=30) {
    digitalWrite(relPin, LOW);
  } 
  else if (relay==true) {
    digitalWrite(relPin, LOW);
  }
  else if (ultra<=5) {
    digitalWrite(relPin, LOW);
  }
  else {
    digitalWrite(relPin, HIGH);
  }
    
}

void onSuhuChange() {
  // Add your code here to act upon Suhu change
}

void onKelembabanChange() {
  // Add your code here to act upon Kelembaban change
}

void onLedChange() {
  // Add your code here to act upon Led change
}

void onRelayChange()  {
  
}
void onUltraChange()  {
  
}
